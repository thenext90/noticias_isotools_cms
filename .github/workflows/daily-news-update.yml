name: ğŸ—ï¸ ActualizaciÃ³n Diaria de Noticias ISO

# Permisos necesarios para el GitHub Action
permissions:
  contents: write
  actions: read

on:
  # Se ejecuta todos los dÃ­as a las 6:00 UTC (12:00 PM en EspaÃ±a)
  schedule:
    - cron: '0 6 * * *'
  
  # TambiÃ©n permite ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forzar actualizaciÃ³n aunque ya exista archivo de hoy'
        required: false
        default: false
        type: boolean

jobs:
  update-daily-news:
    runs-on: ubuntu-latest
    name: ğŸ“° Generar Noticias Diarias
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'isotools-summaries-standalone/package.json'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        cd isotools-summaries-standalone
        npm install
        
    - name: ğŸ—ï¸ Generate daily news
      run: |
        cd isotools-summaries-standalone
        echo "ğŸ² Generando 4 artÃ­culos aleatorios para hoy..."
        node generate-daily-news.js
        
    - name: ğŸ“Š Verify generated files
      run: |
        echo "ğŸ“„ Verificando archivos generados..."
        ls -la isotools-daily-news.json || echo "âŒ Archivo no encontrado en raÃ­z"
        ls -la isotools-summaries-standalone/isotools-daily-news.json || echo "âŒ Archivo no encontrado en subdirectorio"
        
        if [ -f "isotools-daily-news.json" ]; then
          echo "âœ… Archivo de noticias diarias generado correctamente"
          echo "ğŸ“Š TamaÃ±o del archivo: $(wc -c < isotools-daily-news.json) bytes"
          echo "ğŸ“‹ Primeras lÃ­neas:"
          head -10 isotools-daily-news.json
        else
          echo "âŒ Error: No se generÃ³ el archivo de noticias"
          exit 1
        fi
        
    - name: ğŸ·ï¸ Get current date
      id: date
      run: echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
    - name: ğŸ“ Commit and push changes
      run: |
        # Configurar git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Daily News"
        
        # Verificar si hay cambios
        if git diff --quiet && git diff --staged --quiet; then
          echo "â„¹ï¸ No hay cambios para commitear"
        else
          # Agregar archivos
          git add isotools-daily-news.json
          git add isotools-summaries-standalone/isotools-daily-news.json
          
          # Commit con mensaje descriptivo
          git commit -m "ğŸ—ï¸ Noticias diarias actualizadas - ${{ steps.date.outputs.TODAY }}

          ğŸ² 4 artÃ­culos aleatorios seleccionados para hoy
          ğŸ“… Fecha: ${{ steps.date.outputs.TODAY }}
          ğŸ¤– Generado automÃ¡ticamente por GitHub Actions
          ğŸ”„ PrÃ³xima actualizaciÃ³n: maÃ±ana a las 6:00 UTC
          
          âš™ï¸ ConfiguraciÃ³n:
          - RotaciÃ³n diaria: âœ… Activada
          - SelecciÃ³n aleatoria: âœ… Algoritmo seeded
          - Auto-update: âœ… Programado
          
          ğŸ“Š Archivo actualizado: isotools-daily-news.json
          ğŸŒ Consumible vÃ­a: GitHub RAW URL"
          
          # Push al repositorio usando el token por defecto
          git push origin main
          
          echo "âœ… Cambios pusheados exitosamente"
        fi
        
    - name: ğŸ“‹ Summary
      run: |
        echo "ğŸ‰ ACTUALIZACIÃ“N DIARIA COMPLETADA"
        echo "=================================="
        echo "ğŸ“… Fecha: ${{ steps.date.outputs.TODAY }}"
        echo "ğŸ“„ Archivo: isotools-daily-news.json"
        echo "ğŸ² ArtÃ­culos: 4 seleccionados aleatoriamente"
        echo "ğŸ”„ PrÃ³xima ejecuciÃ³n: MaÃ±ana a las 6:00 UTC"
        echo ""
        echo "ğŸŒ URLs de consumo:"
        echo "ğŸ“± RAW: https://raw.githubusercontent.com/${{ github.repository }}/main/isotools-daily-news.json"
        echo "ğŸ“Š Repo: https://github.com/${{ github.repository }}/blob/main/isotools-daily-news.json"
        
    - name: ğŸš¨ Notify on failure
      if: failure()
      run: |
        echo "âŒ ERROR EN LA ACTUALIZACIÃ“N DIARIA"
        echo "==================================="
        echo "ğŸ”§ Revisa los logs anteriores para identificar el problema"
        echo "ğŸ“§ Considera configurar notificaciones de Slack/Email"
        echo "ğŸ”„ La siguiente ejecuciÃ³n serÃ¡ maÃ±ana a las 6:00 UTC"